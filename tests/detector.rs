use std::sync::Once;

use evm_proxy_tools::{get_proxy_type, ProxyType, Dispatch};
use alloy_primitives::{Address, U256};
use tracing_subscriber::{EnvFilter, FmtSubscriber};

static INIT: Once = Once::new();

fn init() {
    INIT.call_once(|| {
        let filter = EnvFilter::from_default_env();

        FmtSubscriber::builder()
            .with_env_filter(filter)
            .init();
    });
}

#[test]
fn test_eip_1167() {
    init();
    assert_eq!(get_proxy_type(&hex_literal::hex!("363d3d373d3d3d363d73bebebebebebebebebebebebebebebebebebebebe5af43d82803e903d91602b57fd5bf3")), Some((ProxyType::Eip1167, Dispatch::Static(Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"))))));
    assert_eq!(get_proxy_type(&hex_literal::hex!("363d3d373d3d3d363d6fbebebebebebebebebebebebebebebebe5af43d82803e903d91602b57fd5bf3")), Some((ProxyType::Eip1167, Dispatch::Static(Address::from(hex_literal::hex!("00000000bebebebebebebebebebebebebebebebe"))))));
    assert!(get_proxy_type(&hex_literal::hex!("9999999999")).is_none());
    assert!(get_proxy_type(&hex_literal::hex!("9999999999aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")).is_none());
}

#[test]
fn test_eip_7511() {
    init();
    assert_eq!(get_proxy_type(&hex_literal::hex!("365f5f375f5f365f73bebebebebebebebebebebebebebebebebebebebe5af43d5f5f3e5f3d91602a57fd5bf3")), Some((ProxyType::Eip7511, Dispatch::Static(Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"))))));
    assert_eq!(get_proxy_type(&hex_literal::hex!("365f5f375f5f365f6fbebebebebebebebebebebebebebebebe5af43d5f5f3e5f3d91602a57fd5bf3")), Some((ProxyType::Eip7511, Dispatch::Static(Address::from(hex_literal::hex!("00000000bebebebebebebebebebebebebebebebe"))))));
    assert!(get_proxy_type(&hex_literal::hex!("9999999999")).is_none());
    assert!(get_proxy_type(&hex_literal::hex!("9999999999aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")).is_none());
}

#[test]
fn test_eip_3448() {
    init();
    assert_eq!(get_proxy_type(&hex_literal::hex!("363d3d373d3d3d3d60368038038091363936013d73bebebebebebebebebebebebebebebebebebebebe5af43d3d93803e603457fd5bf3")), Some((ProxyType::Eip3448, Dispatch::Static(Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"))))));
    assert_eq!(get_proxy_type(&hex_literal::hex!("363d3d373d3d3d3d60368038038091363936013d6fbebebebebebebebebebebebebebebebe5af43d3d93803e603457fd5bf3")), Some((ProxyType::Eip3448, Dispatch::Static(Address::from(hex_literal::hex!("00000000bebebebebebebebebebebebebebebebe"))))));
    assert!(get_proxy_type(&hex_literal::hex!("9999999999")).is_none());
    assert!(get_proxy_type(&hex_literal::hex!("9999999999aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")).is_none());
}

#[test]
fn test_diamond_zksyncera() {
    init();
    // https://etherscan.io/address/0x32400084c286cf3e17e7b677ea9583e60a000324#code
    assert_eq!(get_proxy_type(&hex_literal::hex!("6080604052600080516020611042833981519152600436101580610021575036155b6100575760405162461bcd60e51b8152602060048201526002602482015261155d60f21b60448201526064015b60405180910390fd5b600080356001600160e01b03191681526020828152604091829020825160608101845290546001600160a01b038116808352600160a01b820461ffff1693830193909352600160b01b900460ff16151592810192909252806100df5760405162461bcd60e51b81526020600482015260016024820152602360f91b604482015260640161004e565b600383015460ff1615806100f557508160400151155b6101265760405162461bcd60e51b8152602060048201526002602482015261713160f01b604482015260640161004e565b60405136600082376000803683855af43d806000843e818015610147578184f35b8184fd5b805160208201516040830151825160005b818110156102d257600085828151811061017857610178610e29565b6020026020010151602001519050600086838151811061019a5761019a610e29565b602002602001015160000151905060008784815181106101bc576101bc610e29565b602002602001015160400151905060008885815181106101de576101de610e29565b602002602001015160600151905060008151116102215760405162461bcd60e51b81526020600482015260016024820152602160f91b604482015260640161004e565b600084600281111561023557610235610e3f565b0361024a5761024583828461038c565b6102bd565b600184600281111561025e5761025e610e3f565b0361026e576102458382846104b2565b600284600281111561028257610282610e3f565b036102915761024583826105db565b60405162461bcd60e51b81526020600482015260016024820152604360f81b604482015260640161004e565b505050506102cb8160010190565b905061015c565b506102dd83836106fa565b7f87b829356b3403d36217eff1f66ee48eacd0a69015153aba4f0de29fe5340c3084848460405161031093929190610ea5565b60405180910390a15050505050565b60010190565b600061ffff8211156103885760405162461bcd60e51b815260206004820152602660248201527f53616665436173743a2076616c756520646f65736e27742066697420696e203160448201526536206269747360d01b606482015260840161004e565b5090565b6000805160206110428339815191526001600160a01b0384166103d55760405162461bcd60e51b81526020600482015260016024820152604760f81b604482015260640161004e565b6103de84610877565b825160005b818110156104aa5760008582815181106103ff576103ff610e29565b6020908102919091018101516001600160e01b031981166000908152868352604090819020815160608101835290546001600160a01b038116808352600160a01b820461ffff1695830195909552600160b01b900460ff1615159181019190915290925090156104955760405162461bcd60e51b81526020600482015260016024820152602560f91b604482015260640161004e565b6104a0888388610920565b50506001016103e3565b505050505050565b6000805160206110428339815191526001600160a01b0384166104fb5760405162461bcd60e51b81526020600482015260016024820152604b60f81b604482015260640161004e565b825160005b818110156104aa57600085828151811061051c5761051c610e29565b6020908102919091018101516001600160e01b031981166000908152868352604090819020815160608101835290546001600160a01b038116808352600160a01b820461ffff1695830195909552600160b01b900460ff16151591810191909152909250906105b15760405162461bcd60e51b81526020600482015260016024820152601360fa1b604482015260640161004e565b80516105bd9083610adf565b6105c688610877565b6105d1888388610920565b5050600101610500565b6000805160206110428339815191526001600160a01b038316156106265760405162461bcd60e51b8152602060048201526002602482015261613160f01b604482015260640161004e565b815160005b818110156106f357600084828151811061064757610647610e29565b6020908102919091018101516001600160e01b031981166000908152868352604090819020815160608101835290546001600160a01b038116808352600160a01b820461ffff1695830195909552600160b01b900460ff16151591810191909152909250906106dd5760405162461bcd60e51b8152602060048201526002602482015261309960f11b604482015260640161004e565b80516106e99083610adf565b505060010161062b565b5050505050565b6001600160a01b03821661073f5780511561073b5760405162461bcd60e51b81526020600482015260016024820152600960fb1b604482015260640161004e565b5050565b600080836001600160a01b03168360405161075a9190610faf565b600060405180830381855af49150503d8060008114610795576040519150601f19603f3d011682016040523d82523d6000602084013e61079a565b606091505b5091509150816107d05760405162461bcd60e51b81526020600482015260016024820152604960f81b604482015260640161004e565b80516020146108065760405162461bcd60e51b815260206004820152600260248201526106c760f41b604482015260640161004e565b7f33774e659306e47509050e97cb651e731180a42d458212294d30751925c551a260001b8180602001905181019061083e9190610fcb565b146108715760405162461bcd60e51b81526020600482015260036024820152626c703160e81b604482015260640161004e565b50505050565b6001600160a01b038116600090815260008051602061102283398151915260205260408120546000805160206110428339815191529181900361091b5760028201546108c290610325565b6001600160a01b038416600081815260018581016020908152604083208201805461ffff191661ffff96909616959095179094556002860180549182018155825292902090910180546001600160a01b03191690911790555b505050565b6001600160a01b03831660009081526000805160206110228339815191526020526040812054600080516020611042833981519152919061096090610325565b905061ffff811615610a15576001600160a01b038516600090815260018301602052604081208054829061099657610996610e29565b6000918252602080832060088304015460079092166004026101000a90910460e01b6001600160e01b03198116835290859052604090912054909150600160b01b900460ff16151584151514610a135760405162461bcd60e51b81526020600482015260026024820152614a3160f01b604482015260640161004e565b505b604080516060810182526001600160a01b0396871680825261ffff93841660208084019182529615158385019081526001600160e01b03198916600090815287895285812094518554935192519b166001600160b01b031990931692909217600160a01b91909616029490941760ff60b01b1916600160b01b981515989098029790971790559481526001918201835293842080549182018155845292206008830401805463ffffffff60079094166004026101000a938402191660e09290921c92909202179055565b6001600160e01b03198116600090815260008051602061104283398151915260208181526040808420546001600160a01b03871685526000805160206110228339815191529092528320549192600160a01b90910461ffff1691610b4590600190610fe4565b9050808214610c3e576001600160a01b03851660009081526001840160205260408120805483908110610b7a57610b7a610e29565b600091825260208083206008830401546001600160a01b038a168452600188019091526040909220805460079092166004026101000a90920460e01b925082919085908110610bcb57610bcb610e29565b90600052602060002090600891828204019190066004026101000a81548163ffffffff021916908360e01c0217905550610c0483610325565b6001600160e01b03199091166000908152602085905260409020805461ffff92909216600160a01b0261ffff60a01b199092169190911790555b6001600160a01b03851660009081526001840160205260409020805480610c6757610c6761100b565b60008281526020808220600860001990940193840401805463ffffffff600460078716026101000a0219169055919092556001600160e01b0319861682528490526040812080546001600160b81b03191690558190036106f3576001600160a01b0385166000908152600080516020611022833981519152602052604081206001908101547fc8fcad8db84d3cc18b4c41d551ea0ee66dd599cde068d998e57d5e09332c131d546106f39389936000805160206110428339815191529361ffff1692610d339190610fe4565b9050808214610dee576000836002018281548110610d5357610d53610e29565b6000918252602090912001546002850180546001600160a01b039092169250829185908110610d8457610d84610e29565b9060005260206000200160006101000a8154816001600160a01b0302191690836001600160a01b03160217905550610dbb83610325565b6001600160a01b039190911660009081526001858101602052604090912001805461ffff191661ffff9092169190911790555b82600201805480610e0157610e0161100b565b600082815260209020810160001990810180546001600160a01b031916905501905550505050565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052602160045260246000fd5b60005b83811015610e70578181015183820152602001610e58565b50506000910152565b60008151808452610e91816020860160208601610e55565b601f01601f19169290920160200192915050565b60006060808301818452808751808352608092508286019150828160051b8701016020808b0160005b84811015610f7f57898403607f19018652815180516001600160a01b03168552838101518886019060038110610f1457634e487b7160e01b600052602160045260246000fd5b868601526040828101511515908701529089015189860189905280519182905284019060009060a08701905b80831015610f6a5783516001600160e01b0319168252928601926001929092019190860190610f40565b50978501979550505090820190600101610ece565b50506001600160a01b038a16908801528681036040880152610fa18189610e79565b9a9950505050505050505050565b60008251610fc1818460208701610e55565b9190910192915050565b600060208284031215610fdd57600080fd5b5051919050565b8181038181111561100557634e487b7160e01b600052601160045260246000fd5b92915050565b634e487b7160e01b600052603160045260246000fdfec8fcad8db84d3cc18b4c41d551ea0ee66dd599cde068d998e57d5e09332c131cc8fcad8db84d3cc18b4c41d551ea0ee66dd599cde068d998e57d5e09332c131ba2646970667358221220321b01261069b5a16f3e8ffab503a6323741f79d0634fcd86190942b13f5966764736f6c63430008110033")), Some((ProxyType::Eip2535, Dispatch::DiamondStorage)));
}

#[test]
fn test_diamond_standard() {
    init();
    assert_eq!(get_proxy_type(&hex_literal::hex!("6080604052600436101561001e575b361561001c5761001c61131a565b005b60003560e01c806301ffc9a71461010e5780631f931c1c146101055780632c408059146100fc57806352ef6b2c146100f357806379ba5097146100ea5780637a0ed627146100e15780638ab5150a146100d85780638da5cb5b146100cf57806391423765146100c6578063adfca15e146100bd578063cdffacc6146100b45763f2fde38b0361000e576100af611160565b61000e565b506100af6110cc565b506100af610eed565b506100af610dc6565b506100af610d54565b506100af610ce2565b506100af610968565b506100af610694565b506100af6103ff565b506100af61033c565b506100af6102a3565b506100af610178565b600435907fffffffff000000000000000000000000000000000000000000000000000000008216820361014657565b600080fd5b35907fffffffff000000000000000000000000000000000000000000000000000000008216820361014657565b50346101465760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610146577fffffffff000000000000000000000000000000000000000000000000000000006101d1610117565b166000527f326d0c59a7612f6a9919e2a8ee333c80ba689d8ba2634de89c85cbb04832e705602052602060ff604060002054166040519015158152f35b6024359073ffffffffffffffffffffffffffffffffffffffff8216820361014657565b6004359073ffffffffffffffffffffffffffffffffffffffff8216820361014657565b359073ffffffffffffffffffffffffffffffffffffffff8216820361014657565b9181601f840112156101465782359167ffffffffffffffff8311610146576020838186019501011161014657565b50346101465760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126101465760043567ffffffffffffffff808211610146573660238301121561014657816004013591818311610146573660248460051b830101116101465761031561020e565b6044359283116101465761001c936103336024943690600401610275565b949093016116f9565b50346101465760007ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261014657602073ffffffffffffffffffffffffffffffffffffffff7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc965416604051908152f35b6020908160408183019282815285518094520193019160005b8281106103d5575050505090565b835173ffffffffffffffffffffffffffffffffffffffff16855293810193928101926001016103c7565b5034610146576000807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126106915761046661045f7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc945461ffff1690565b61ffff1690565b90610470826115c9565b908080815b858210610491578385526040518061048d87826103ae565b0390f35b6104c4816000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b5483905b600882106104e1575b50506104dc9061163e565b610475565b9195939690926104f09061163e565b94818611610684576105a66105a061057a7fffffffff00000000000000000000000000000000000000000000000000000000868860051b1b167fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b547fffffffffffffffffffffffffffffffffffffffff0000000000000000000000001690565b60601c90565b8873ffffffffffffffffffffffffffffffffffffffff8216815b848110610621575b505061061657816105fe610603926105e3610609958a6116be565b9073ffffffffffffffffffffffffffffffffffffffff169052565b61163e565b9361163e565b90969395919492946104c8565b50926106099061163e565b61066461064b610631838c6116be565b5173ffffffffffffffffffffffffffffffffffffffff1690565b73ffffffffffffffffffffffffffffffffffffffff1690565b8214610678576106739061163e565b6105c0565b505050600138806105c8565b94928197949692506104d1565b80fd5b5034610146576000807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126106915773ffffffffffffffffffffffffffffffffffffffff807f24aa1f7b31fd188a8d3ecfb06bc55c806040e59b03bd4396283442fce6617890541633036107e55733907f8a22373512790c48b83a1fe2efdd2888d4a917bcdc24d0adf63e60f67168046054167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08380a37f8a22373512790c48b83a1fe2efdd2888d4a917bcdc24d0adf63e60f67168046080547fffffffffffffffffffffffff000000000000000000000000000000000000000016331790556107e27f24aa1f7b31fd188a8d3ecfb06bc55c806040e59b03bd4396283442fce66178907fffffffffffffffffffffffff00000000000000000000000000000000000000008154169055565b80f35b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602960248201527f536166654f776e61626c653a2073656e646572206d757374206265206e6f6d6960448201527f6e6565206f776e657200000000000000000000000000000000000000000000006064820152fd5b90815180825260208080930193019160005b828110610889575050505090565b83517fffffffff00000000000000000000000000000000000000000000000000000000168552938101939281019260010161087b565b602080820190808352835180925260409283810182858560051b8401019601946000925b8584106108f4575050505050505090565b909192939495968580610957837fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc0866001960301885286838d5173ffffffffffffffffffffffffffffffffffffffff815116845201519181858201520190610869565b9901940194019295949391906108e3565b5034610146576000807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610691576109c861045f7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc945461ffff1690565b6109d181611532565b906109db816115c9565b92809181825b828210610a3f575050505b818110610a04578183526040518061048d85826108bf565b80610a25610a1f610a18610a3a94886116be565b5160ff1690565b60ff1690565b6020610a3183876116be565b5101515261163e565b6109ec565b610a72816000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b5484905b60088210610a8f575b5050610a8a9061163e565b6109e1565b9093919692610aa09098959861163e565b95828711610cd5577fffffffff00000000000000000000000000000000000000000000000000000000828660051b1b16610b2b6105a061057a837fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b8a73ffffffffffffffffffffffffffffffffffffffff8216815b858110610c12575b5050610c065791610bde610bf192610b88610bf795610b6c858b6116be565b519073ffffffffffffffffffffffffffffffffffffffff169052565b610bb7610b94886115c9565b60209081610ba2878d6116be565b510152610baf858b6116be565b5101516116a8565b907fffffffff00000000000000000000000000000000000000000000000000000000169052565b6105fe610beb828a6116be565b60019052565b9461163e565b90979497969193959296610a76565b505093610bf79061163e565b8a858a84610c4161064b610c2687856116be565b515173ffffffffffffffffffffffffffffffffffffffff1690565b14610c5757505050610c529061163e565b610b45565b610ccc955083809550610cbd93610c99610cb894610bb76020610c80610cc49a610a18986116be565b510151610c93610a1f610a1888886116be565b906116be565b610cb360ff80610cac610a1886866116be565b16106116e0565b6116be565b6116e7565b918b6116be565b9060ff169052565b60013880610b4d565b9592969193979497610a7f565b50346101465760007ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261014657602073ffffffffffffffffffffffffffffffffffffffff7f24aa1f7b31fd188a8d3ecfb06bc55c806040e59b03bd4396283442fce66178905416604051908152f35b50346101465760007ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261014657602073ffffffffffffffffffffffffffffffffffffffff7f8a22373512790c48b83a1fe2efdd2888d4a917bcdc24d0adf63e60f6716804605416604051908152f35b50346101465760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261014657610dfe610231565b73ffffffffffffffffffffffffffffffffffffffff610e41817f8a22373512790c48b83a1fe2efdd2888d4a917bcdc24d0adf63e60f6716804605416331461122a565b7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc9691167fffffffffffffffffffffffff0000000000000000000000000000000000000000825416179055600080f35b6020908160408183019282815285518094520193019160005b828110610eb7575050505090565b83517fffffffff000000000000000000000000000000000000000000000000000000001685529381019392810192600101610ea9565b50346101465760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261014657610f25610231565b610f5461045f7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc945461ffff1690565b90610f5e826115c9565b9060009073ffffffffffffffffffffffffffffffffffffffff1681805b858210610f93578385526040518061048d8782610e90565b610fc6816000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b5460005b60088110610fe3575b5050610fde9061163e565b610f7b565b9492610ff49097919796929661163e565b948186116110be577fffffffff00000000000000000000000000000000000000000000000000000000888260051b1b1661108261064b6105a061057a847fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b86146110a1575b506110939061163e565b969096959195949294610fca565b846105fe6110b792610bb76110939598886116be565b9390611089565b819750959195949294610fd3565b50346101465760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610146577fffffffff00000000000000000000000000000000000000000000000000000000611125610117565b166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052602060406000205460601c604051908152f35b50346101465760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261014657611198610231565b73ffffffffffffffffffffffffffffffffffffffff6111db817f8a22373512790c48b83a1fe2efdd2888d4a917bcdc24d0adf63e60f6716804605416331461122a565b7f24aa1f7b31fd188a8d3ecfb06bc55c806040e59b03bd4396283442fce661789091167fffffffffffffffffffffffff0000000000000000000000000000000000000000825416179055600080f35b1561123157565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601d60248201527f4f776e61626c653a2073656e646572206d757374206265206f776e65720000006044820152fd5b1561129657565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602660248201527f50726f78793a20696d706c656d656e746174696f6e206d75737420626520636f60448201527f6e747261637400000000000000000000000000000000000000000000000000006064820152fd5b5060007fffffffff0000000000000000000000000000000000000000000000000000000081351681527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc9360205280604081205460601c801561139f575b8061138583923b151561128f565b368280378136915af43d82803e1561139b573d90f35b3d90fd5b505073ffffffffffffffffffffffffffffffffffffffff7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc96541680156113e6578190611377565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152603260248201527f4469616d6f6e64426173653a206e6f20666163657420666f756e6420666f722060448201527f66756e6374696f6e207369676e617475726500000000000000000000000000006064820152fd5b507f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051906060820182811067ffffffffffffffff8211176114ba57604052565b6114c261146a565b604052565b907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f604051930116820182811067ffffffffffffffff8211176114ba57604052565b60209067ffffffffffffffff8111611525575b60051b0190565b61152d61146a565b61151e565b9061154461153f8361150b565b6114c7565b8281527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0611572829461150b565b0190600090815b8381106115865750505050565b60209060408051908082019082821067ffffffffffffffff8311176115bc575b5284815282606081830152828501015201611579565b6115c461146a565b6115a6565b906115d661153f8361150b565b8281527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0611604829461150b565b0190602036910137565b507f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6001907fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff811461166c570190565b61167461160e565b0190565b507f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020908051156116b6570190565b611674611678565b60209181518110156116d3575b60051b010190565b6116db611678565b6116cb565b1561014657565b60ff6001911660ff811461166c570190565b949390929461174073ffffffffffffffffffffffffffffffffffffffff7f8a22373512790c48b83a1fe2efdd2888d4a917bcdc24d0adf63e60f6716804605416331461122a565b61174c61153f8561150b565b9081948083526020809301600591821b8301923684116101465780915b84831061178e5750505050505061178c93946117869136916118a2565b91611b14565b565b67ffffffffffffffff8335818111610146578301606081360312610146576117b461149a565b916117be82610254565b835288820135600381101561014657898401526040918281013591821161014657019036601f83011215610146578135916117fb61153f8461150b565b928a808583815201918a1b8301019136831161014657918b80969492979593015b818110611836575050849550820152815201920191611769565b91939580919395976118478461014b565b8152019101918b95939196949261181c565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f60209267ffffffffffffffff8111611895575b01160190565b61189d61146a565b61188f565b9291926118b161153f83611859565b938285528282011161014657816000926020928387013784010152565b600311156118d857565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602160045260246000fd5b1561190e57565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602360248201527f4469616d6f6e64426173653a206e6f2073656c6563746f72732073706563696660448201527f69656400000000000000000000000000000000000000000000000000000000006064820152fd5b919082519283825260005b8481106119dc5750507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8460006020809697860101520116010190565b60208183018101518483018201520161199d565b93929091936060928382019380835281518095526080830160808660051b85010195602080940192600080915b838310611a6057505050505050611a5d9495611a509183019073ffffffffffffffffffffffffffffffffffffffff169052565b6040818403910152611992565b90565b9091929394987fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8088820301865289519073ffffffffffffffffffffffffffffffffffffffff8251168152878201516003811015611ae757611ad960019385848c9594868096015281604080940151938201520190610869565b9b0196019493019190611a1d565b6024857f4e487b710000000000000000000000000000000000000000000000000000000081526021600452fd5b9091611b4561045f7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc945461ffff1690565b91829460009260078516611cf2575b6000935b8351851015611c0b57611b6b85856116be565b51906020820151611b7b816118ce565b611b8b6040840151511515611907565b611b94816118ce565b80611bb3575090611ba89160019697611e47565b9490955b0193611b58565b611bc081979392976118ce565b60018103611bda575090611bd560019261275b565b611bac565b80611be66002926118ce565b14611bf5575b50600190611bac565b600195611c02929761221c565b94909590611bec565b8694507f8faa70878671ccd212d20771b795c50af8fd3ff6cf27f4bde57e5d4de0aeb67393919561178c9793988103611ca0575b60078116611c62575b5050611c5a85604051938493846119f0565b0390a161298d565b611c989060031c6000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b553880611c48565b7f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc9480547fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00001661ffff8316179055611c3f565b9250611d2a8460031c6000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b5492611b54565b15611d3857565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602360248201527f4469616d6f6e64426173653a204144442074617267657420686173206e6f206360448201527f6f646500000000000000000000000000000000000000000000000000000000006064820152fd5b15611dc357565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602360248201527f4469616d6f6e64426173653a2073656c6563746f7220616c726561647920616460448201527f64656400000000000000000000000000000000000000000000000000000000006064820152fd5b90929192611e93611e6c855173ffffffffffffffffffffffffffffffffffffffff1690565b3073ffffffffffffffffffffffffffffffffffffffff821614908115612096575b50611d31565b60009384925b6040820151805185101561208c57611eb485611eda926116be565b517fffffffff000000000000000000000000000000000000000000000000000000001690565b611f41611f3b61064b6105a061057a857fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b15611dbc565b817fffffffffffffffffffffffffffffffffffffffff000000000000000000000000611fac611f84865173ffffffffffffffffffffffffffffffffffffffff1690565b60601b7fffffffffffffffffffffffffffffffffffffffff0000000000000000000000001690565b1617612003827fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b5560e090818360051b16947fffffffff00000000000000000000000000000000000000000000000000000000809216861c91861c191617931461204d575b60019384019301611e99565b916120848360031c6000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b558491612041565b5092505092509190565b90503b151538611e8d565b156120a857565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602f60248201527f4469616d6f6e64426173653a2052454d4f564520746172676574206d7573742060448201527f6265207a65726f206164647265737300000000000000000000000000000000006064820152fd5b1561213357565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601f60248201527f4469616d6f6e64426173653a2073656c6563746f72206e6f7420666f756e64006044820152fd5b1561219857565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602260248201527f4469616d6f6e64426173653a2073656c6563746f7220697320696d6d7574616260448201527f6c650000000000000000000000000000000000000000000000000000000000006064820152fd5b9061225a73ffffffffffffffffffffffffffffffffffffffff612253855173ffffffffffffffffffffffffffffffffffffffff1690565b16156120a1565b600780831692600390600090821c5b6040870151805183101561263757611eb483612284926116be565b946122da867fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b54966122f68860601c6122ee81151561212c565b301415612191565b816126075750507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0190612353826000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b5494849687915b60e07fffffffff000000000000000000000000000000000000000000000000000000009260006123e7858c600598891b1b169486811686036124d0577fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b5580881c611fff16941b16918584146124be579061246c9291612433856000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b5491831c921c191617916000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b555b851561247e575b60010190612269565b935060006124b5826000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc95602052604060002090565b55600093612475565b9180949893501c921c1916179361246e565b61255061252b61057a887fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b7fffffffffffffffffffffffffffffffffffffffff0000000000000000000000001690565b6bffffffffffffffffffffffff8516176125b5877fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b557fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0196909591929187919061235a565b50939695505090501b179190565b1561264c57565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602760248201527f4469616d6f6e64426173653a205245504c41434520746172676574206861732060448201527f6e6f20636f6465000000000000000000000000000000000000000000000000006064820152fd5b156126d757565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602860248201527f4469616d6f6e64426173653a205245504c41434520746172676574206973206960448201527f64656e746963616c0000000000000000000000000000000000000000000000006064820152fd5b61278a61278561277f835173ffffffffffffffffffffffffffffffffffffffff1690565b3b151590565b612645565b60005b60408201519081518110156128d7576127ab611eb4826001946116be565b6128d0612803827fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b5461284a8160601c61281681151561212c565b61282230821415612191565b61284361064b895173ffffffffffffffffffffffffffffffffffffffff1690565b14156126d0565b6bffffffffffffffffffffffff61287b61252b611f84895173ffffffffffffffffffffffffffffffffffffffff1690565b911617917fffffffff00000000000000000000000000000000000000000000000000000000166000527f177481ac65e4292921c69f62d1cc7f57541261e5d61c8175cf4e36a01c9bfc93602052604060002090565b550161278d565b505050565b156128e357565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602e60248201527f4469616d6f6e64426173653a20696e697469616c697a6174696f6e207461726760448201527f657420686173206e6f20636f64650000000000000000000000000000000000006064820152fd5b3d15612988573d9061297b61153f83611859565b9182523d6000602084013e565b606090565b9073ffffffffffffffffffffffffffffffffffffffff821690811581511581036129fb57156129bb57505050565b600092839230036129ea575b602082519201905af46129d8612967565b50156129e057565b3d6000803e3d6000fd5b6129f6813b15156128dc565b6129c7565b60846040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152602e60248201527f4469616d6f6e64426173653a20696e76616c696420696e697469616c697a617460448201527f696f6e20706172616d65746572730000000000000000000000000000000000006064820152fdfea164736f6c6343000811000a")), Some((ProxyType::Eip2535, Dispatch::DiamondFacets)));
}

#[test]
fn test_diamond_1() {
    init();
    // https://goerli.etherscan.io/address/0xF4355bE7f477bA486D4C454952D209865f6f1f6A#code
    assert_eq!(get_proxy_type(&hex_literal::hex!("6080604052600080516020610ebb833981519152600436101580610021575036155b6100575760405162461bcd60e51b8152602060048201526002602482015261155d60f21b60448201526064015b60405180910390fd5b600080356001600160e01b03191681526020828152604091829020825160608101845290546001600160a01b038116808352600160a01b820461ffff1693830193909352600160b01b900460ff16151592810192909252806100df5760405162461bcd60e51b81526020600482015260016024820152602360f91b604482015260640161004e565b600383015460ff1615806100f557508160400151155b6101265760405162461bcd60e51b8152602060048201526002602482015261713160f01b604482015260640161004e565b60405136600082376000803683855af43d806000843e818015610147578184f35b8184fd5b80516020820151604083015160005b83518110156102d457600084828151811061017757610177610c99565b6020026020010151602001519050600085838151811061019957610199610c99565b602002602001015160000151905060008684815181106101bb576101bb610c99565b602002602001015160400151905060008785815181106101dd576101dd610c99565b602002602001015160600151905060008151116102205760405162461bcd60e51b81526020600482015260016024820152602160f91b604482015260640161004e565b600084600281111561023457610234610caf565b141561024a57610245838284610320565b6102bf565b600184600281111561025e5761025e610caf565b141561026f5761024583828461044d565b600284600281111561028357610283610caf565b141561029357610245838261057e565b60405162461bcd60e51b81526020600482015260016024820152604360f81b604482015260640161004e565b50505050806102cd90610cdb565b905061015a565b506102df82826106a4565b7f87b829356b3403d36217eff1f66ee48eacd0a69015153aba4f0de29fe5340c3083838360405161031293929190610d4e565b60405180910390a150505050565b600080516020610ebb8339815191526001600160a01b0384166103695760405162461bcd60e51b81526020600482015260016024820152604760f81b604482015260640161004e565b610372846107ee565b60005b835181101561044657600084828151811061039257610392610c99565b6020908102919091018101516001600160e01b031981166000908152858352604090819020815160608101835290546001600160a01b038116808352600160a01b820461ffff1695830195909552600160b01b900460ff1615159181019190915290925090156104285760405162461bcd60e51b81526020600482015260016024820152602560f91b604482015260640161004e565b61043387838761088e565b50508061043f90610cdb565b9050610375565b5050505050565b600080516020610ebb8339815191526001600160a01b0384166104965760405162461bcd60e51b81526020600482015260016024820152604b60f81b604482015260640161004e565b61049f846107ee565b60005b83518110156104465760008482815181106104bf576104bf610c99565b6020908102919091018101516001600160e01b031981166000908152858352604090819020815160608101835290546001600160a01b038116808352600160a01b820461ffff1695830195909552600160b01b900460ff16151591810191909152909250906105545760405162461bcd60e51b81526020600482015260016024820152601360fa1b604482015260640161004e565b8051610560908361097d565b61056b87838761088e565b50508061057790610cdb565b90506104a2565b600080516020610ebb8339815191526001600160a01b038316156105c95760405162461bcd60e51b8152602060048201526002602482015261613160f01b604482015260640161004e565b60005b825181101561069e5760008382815181106105e9576105e9610c99565b6020908102919091018101516001600160e01b031981166000908152858352604090819020815160608101835290546001600160a01b038116808352600160a01b820461ffff1695830195909552600160b01b900460ff161515918101919091529092509061067f5760405162461bcd60e51b8152602060048201526002602482015261309960f11b604482015260640161004e565b805161068b908361097d565b50508061069790610cdb565b90506105cc565b50505050565b6001600160a01b0382166106e9578051156106e55760405162461bcd60e51b81526020600482015260016024820152600960fb1b604482015260640161004e565b5050565b600080836001600160a01b0316836040516107049190610e58565b600060405180830381855af49150503d806000811461073f576040519150601f19603f3d011682016040523d82523d6000602084013e610744565b606091505b50915091508161077a5760405162461bcd60e51b81526020600482015260016024820152604960f81b604482015260640161004e565b805160201480156107bd57507f33774e659306e47509050e97cb651e731180a42d458212294d30751925c551a3818060200190518101906107bb9190610e74565b145b61069e5760405162461bcd60e51b815260206004820152600260248201526106c760f41b604482015260640161004e565b6001600160a01b0381166000908152600080516020610edb8339815191526020526040902054600080516020610ebb8339815191529061ffff8116610889576002820180546001600160a01b038516600081815260018087016020908152604083208201805461ffff191661ffff90961695909517909455845490810185559381529190912090910180546001600160a01b03191690911790555b505050565b6001600160a01b039283166000818152600080516020610edb833981519152602081815260408084208054825160608101845296875261ffff9081168785019081529715158784019081526001600160e01b03198a168752600080516020610ebb833981519152855292862096518754985193519a166001600160b01b031990981697909717600160a01b92909716919091029590951760ff60b01b1916600160b01b97151597909702969096179092559084528154600181018355918152929092206008830401805463ffffffff60079094166004026101000a938402191660e09290921c92909202179055565b6001600160e01b031981166000908152600080516020610ebb83398151915260208181526040808420546001600160a01b0387168552600080516020610edb8339815191529092528320549192600160a01b90910461ffff16916109e390600190610e8d565b9050808214610acf576001600160a01b03851660009081526001840160205260408120805483908110610a1857610a18610c99565b600091825260208083206008830401546001600160a01b038a168452600188019091526040909220805460079092166004026101000a90920460e01b925082919085908110610a6957610a69610c99565b600091825260208083206008830401805463ffffffff60079094166004026101000a938402191660e09590951c929092029390931790556001600160e01b031992909216825284905260409020805461ffff60a01b1916600160a01b61ffff8516021790555b6001600160a01b03851660009081526001840160205260409020805480610af857610af8610ea4565b60008281526020808220600860001990940193840401805463ffffffff600460078716026101000a0219169055919092556001600160e01b0319861682528490526040902080546001600160b81b031916905580610446576001600160a01b0385166000908152600080516020610edb833981519152602052604081206001908101547fc8fcad8db84d3cc18b4c41d551ea0ee66dd599cde068d998e57d5e09332c131e54610446938993600080516020610ebb8339815191529361ffff1692610bc29190610e8d565b9050808214610c5e576000836002018281548110610be257610be2610c99565b6000918252602090912001546002850180546001600160a01b039092169250829185908110610c1357610c13610c99565b600091825260208083209190910180546001600160a01b0319166001600160a01b0394851617905592909116815260018581019092526040902001805461ffff191661ffff84161790555b82600201805480610c7157610c71610ea4565b600082815260209020810160001990810180546001600160a01b031916905501905550505050565b634e487b7160e01b600052603260045260246000fd5b634e487b7160e01b600052602160045260246000fd5b634e487b7160e01b600052601160045260246000fd5b6000600019821415610cef57610cef610cc5565b5060010190565b60005b83811015610d11578181015183820152602001610cf9565b8381111561069e5750506000910152565b60008151808452610d3a816020860160208601610cf6565b601f01601f19169290920160200192915050565b60006060808301818452808751808352608092508286019150828160051b8701016020808b0160005b84811015610e2857898403607f19018652815180516001600160a01b03168552838101518886019060038110610dbd57634e487b7160e01b600052602160045260246000fd5b868601526040828101511515908701529089015189860189905280519182905284019060009060a08701905b80831015610e135783516001600160e01b0319168252928601926001929092019190860190610de9565b50978501979550505090820190600101610d77565b50506001600160a01b038a16908801528681036040880152610e4a8189610d22565b9a9950505050505050505050565b60008251610e6a818460208701610cf6565b9190910192915050565b600060208284031215610e8657600080fd5b5051919050565b600082821015610e9f57610e9f610cc5565b500390565b634e487b7160e01b600052603160045260246000fdfec8fcad8db84d3cc18b4c41d551ea0ee66dd599cde068d998e57d5e09332c131cc8fcad8db84d3cc18b4c41d551ea0ee66dd599cde068d998e57d5e09332c131da2646970667358221220f2ae4c1ab9600d895d3228508d0fe01db7bca062f5b0e735e854967361cb7a6d64736f6c63430008090033")), Some((ProxyType::Eip2535, Dispatch::DiamondStorage)));
}


#[test]
fn test_eip_897() {
    init();
    // https://etherscan.io/address/0x1715a3e4a142d8b698131108995174f37aeba10d#code
    assert_eq!(get_proxy_type(&hex_literal::hex!("6080604052600436106100555760003560e01c80633ad06d161461009e57806354fd4d50146100d95780635c60da1b146101005780636fde820214610131578063a9c45fcb14610146578063f1739cae146101cb575b600061005f6101fe565b90506001600160a01b03811661007457600080fd5b60405136600082376000803683855af43d82016040523d6000833e80801561009a573d83f35b3d83fd5b3480156100aa57600080fd5b506100d7600480360360408110156100c157600080fd5b50803590602001356001600160a01b031661020d565b005b3480156100e557600080fd5b506100ee610240565b60408051918252519081900360200190f35b34801561010c57600080fd5b506101156101fe565b604080516001600160a01b039092168252519081900360200190f35b34801561013d57600080fd5b50610115610246565b6100d76004803603606081101561015c57600080fd5b8135916001600160a01b036020820135169181019060608101604082013564010000000081111561018c57600080fd5b82018360208201111561019e57600080fd5b803590602001918460018302840111640100000000831117156101c057600080fd5b509092509050610255565b3480156101d757600080fd5b506100d7600480360360208110156101ee57600080fd5b50356001600160a01b03166102fe565b600061020861038d565b905090565b610215610246565b6001600160a01b0316336001600160a01b03161461023257600080fd5b61023c828261039c565b5050565b60075490565b6006546001600160a01b031690565b61025d610246565b6001600160a01b0316336001600160a01b03161461027a57600080fd5b610284848461020d565b6000306001600160a01b0316348484604051808383808284376040519201945060009350909150508083038185875af1925050503d80600081146102e4576040519150601f19603f3d011682016040523d82523d6000602084013e6102e9565b606091505b50509050806102f757600080fd5b5050505050565b610306610246565b6001600160a01b0316336001600160a01b03161461032357600080fd5b6001600160a01b03811661033657600080fd5b7f5a3e66efaa1e445ebd894728a69d6959842ea1e97bd79b892797106e270efcd961035f610246565b604080516001600160a01b03928316815291841660208301528051918290030190a161038a81610432565b50565b6008546001600160a01b031690565b6008546001600160a01b03828116911614156103b757600080fd5b6103c081610454565b6103c957600080fd5b60075482116103d757600080fd5b6007829055600880546001600160a01b0383166001600160a01b031990911681179091556040805184815290517f4289d6195cf3c2d2174adf98d0e19d4d2d08887995b99cb7b100e7ffe795820e9181900360200190a25050565b600680546001600160a01b0319166001600160a01b0392909216919091179055565b6000813f7fc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a47081811480159061048857508115155b94935050505056fea2646970667358221220c0ef938c3cb0aabada971e1d0565a4ce5504320f0416427bd7838d4790e313e164736f6c63430007050033")), Some((ProxyType::Eip897, Dispatch::Storage(U256::from_be_bytes(hex_literal::hex!("0000000000000000000000000000000000000000000000000000000000000008"))))));
}

#[test]
fn test_eip_1967() {
    init();
    // https://etherscan.io/address/0xdd28b7fd7780e9388582af20e5247e1dcbac8ae9#code
    assert_eq!(get_proxy_type(&hex_literal::hex!("60806040523661001357610011610017565b005b6100115b61004a7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc546001600160a01b031661007b565b565b90565b606061007483836040518060600160405280602781526020016102316027913961009f565b9392505050565b3660008037600080366000845af43d6000803e80801561009a573d6000f35b3d6000fd5b6060833b6101035760405162461bcd60e51b815260206004820152602660248201527f416464726573733a2064656c65676174652063616c6c20746f206e6f6e2d636f6044820152651b9d1c9858dd60d21b60648201526084015b60405180910390fd5b600080856001600160a01b03168560405161011e91906101b1565b600060405180830381855af49150503d8060008114610159576040519150601f19603f3d011682016040523d82523d6000602084013e61015e565b606091505b509150915061016e828286610178565b9695505050505050565b60608315610187575081610074565b8251156101975782518084602001fd5b8160405162461bcd60e51b81526004016100fa91906101cd565b600082516101c3818460208701610200565b9190910192915050565b60208152600082518060208401526101ec816040850160208701610200565b601f01601f19169190910160400192915050565b60005b8381101561021b578181015183820152602001610203565b8381111561022a576000848401525b5050505056fe416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c206661696c6564a2646970667358221220727e9c7322af70a33c460d6c97b3533591ca0a1b66f567d29a66e092f79e0a0d64736f6c63430008070033")), Some((ProxyType::Eip1967, Dispatch::Storage(U256::from_be_bytes(hex_literal::hex!("360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc"))))));
}

#[test]
fn test_zero_age_minimal() {
    init();
    let addr = Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"));
    let code = hex_literal::hex!("3d3d3d3d363d3d37363d73bebebebebebebebebebebebebebebebebebebebe5af43d3d93803e602a57fd5bf3");
    assert_eq!(get_proxy_type(&code), Some((ProxyType::ZeroAgeMinimal, Dispatch::Static(addr))));
}

#[test]
fn test_solady_push0() {
    init();
    let addr = Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"));
    let code = hex_literal::hex!("5f5f365f5f37365f73bebebebebebebebebebebebebebebebebebebebe5af43d5f5f3e6029573d5ffd5b3d5ff3");
    assert_eq!(get_proxy_type(&code), Some((ProxyType::SoladyPush0, Dispatch::Static(addr))));
}

#[test]
fn test_vyper_beta() {
    init();
    let addr = Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"));
    let code = hex_literal::hex!("366000600037611000600036600073bebebebebebebebebebebebebebebebebebebebe5af41558576110006000f3");
    assert_eq!(get_proxy_type(&code), Some((ProxyType::VyperBeta, Dispatch::Static(addr))));
}

#[test]
fn test_sequence_wallet() {
    init();
    let code = hex_literal::hex!("363d3d373d3d3d363d30545af43d82803e903d91601857fd5bf3");
    assert_eq!(get_proxy_type(&code), Some((ProxyType::SequenceWallet, Dispatch::SelfAddressSlot)));
}

#[test]
fn test_zero_x_splits_clones() {
    init();
    let addr = Address::from(hex_literal::hex!("bebebebebebebebebebebebebebebebebebebebe"));
    let code = hex_literal::hex!("36603057343d52307f830d2d700a97af574b186c80d40429385d24241565b08a7c559ba283a964d9b160203da23d3df35b3d3d3d3d363d3d37363d73bebebebebebebebebebebebebebebebebebebebe5af43d3d93803e605b57fd5bf3");
    assert_eq!(get_proxy_type(&code), Some((ProxyType::ZeroXSplitsClones, Dispatch::Static(addr))));
}

#[test]
fn test_eip_6551_token_bound_account() {
    init();
    let impl_addr = Address::from(hex_literal::hex!("2d25602551487c3f3354dd80d76d54383a243358"));
    let code = hex_literal::hex!(
        "363d3d373d3d3d363d732d25602551487c3f3354dd80d76d54383a2433585af43d82803e903d91602b57fd5bf3"
        "0000000000000000000000000000000000000000000000000000000000000001"
        "0000000000000000000000000000000000000000000000000000000000000001"
        "000000000000000000000000a87ea7c8745980490bcdcff97fe7328535098cd1"
        "0000000000000000000000000000000000000000000000000000000000000001"
    );
    
    let result = get_proxy_type(&code);
    assert!(result.is_some());
    let (proxy_type, dispatch) = result.unwrap();
    assert_eq!(proxy_type, ProxyType::Eip6551);
    
    match dispatch {
        Dispatch::Static6551 { implementation, chain_id, token_contract, token_id } => {
            assert_eq!(implementation, impl_addr);
            assert_eq!(chain_id, U256::from(1));
            assert_eq!(token_contract, Address::from(hex_literal::hex!("a87ea7c8745980490bcdcff97fe7328535098cd1")));
            assert_eq!(token_id, U256::from(1));
        },
        _ => panic!("Expected Static6551 dispatch"),
    }
}

#[test]
fn test_gnosis_safe_proxy() {
    init();
    let code = hex_literal::hex!(
        "608060405273ffffffffffffffffffffffffffffffffffffffff600054167fa619486e0000"
        "0000000000000000000000000000000000000000000000000000600035141560505780"
        "60005260206000f35b3660008037600080366000845af43d6000803e60008114606c57"
        "3d6000f35b3d6000fdfea2646970667358221220d1429297349653a4918076d650332d"
        "e1a1068c5f3e07c5c82360c277770b955264736f6c63430007060033"
    );
    
    let result = get_proxy_type(&code);
    assert!(result.is_some());
    let (proxy_type, dispatch) = result.unwrap();
    assert_eq!(proxy_type, ProxyType::GnosisSafe);
    assert_eq!(dispatch, Dispatch::Storage(U256::ZERO));
}
